name: Clean Up Old Workflow Logs

on:
  schedule:
    - cron: '0 0 * * *'  # 每天午夜运行
  workflow_dispatch:  # 允许手动运行

jobs:
  cleanup_logs:
    runs-on: ubuntu-latest
    steps:
      - name: Set up GitHub CLI
        uses: cli/cli@v2
        with:
          version: latest

      - name: Get workflows
        id: get_workflows
        run: |
          workflows=$(gh api -X GET /repos/${{ github.repository }}/actions/runs --jq '.workflow_runs[] | select(.created_at < "'$(date -d '30 days ago' --rfc-3339=seconds)'") | .id')
          echo "::set-output name=workflows::$workflows"

      - name: Delete old workflows
        if: steps.get_workflows.outputs.workflows != ''
        run: |
          for workflow_id in ${{ steps.get_workflows.outputs.workflows }}; do
            gh api -X DELETE /repos/${{ github.repository }}/actions/runs/$workflow_id
            echo "Deleted workflow run $workflow_id"
          done
