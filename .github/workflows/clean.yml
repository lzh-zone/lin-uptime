name: Cleanup Workflows

on:
  schedule:
    - cron: '0 0 * * *'  # 每天0点执行一次清理任务
  workflow_dispatch: # 允许手动触发

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install GitHub CLI manually
        run: |
          # 获取最新版本的GitHub CLI下载链接
          VERSION=$(curl -s https://api.github.com/repos/cli/cli/releases/latest | jq -r .tag_name)
          DOWNLOAD_URL="https://github.com/cli/cli/releases/download/$VERSION/gh_${VERSION#v}_linux_amd64.deb"
          
          # 下载并安装GitHub CLI
          curl -fsSL $DOWNLOAD_URL -o gh.deb
          sudo dpkg -i gh.deb
          sudo apt-get install -f  # 安装任何缺失的依赖

      - name: Authenticate with GitHub CLI
        run: gh auth login --with-token < ${{ secrets.GITHUB_TOKEN }}

      - name: Get workflows older than 30 days
        run: |
          # 获取所有工作流
          workflows=$(gh run list --limit 1000 --json createdAt,workflowRunUrl)
          
          # 获取当前日期并设置时间阈值（30天前）
          threshold=$(date -d "30 days ago" +%Y-%m-%dT%H:%M:%S)
          
          # 遍历工作流并删除30天前的工作流
          echo "$workflows" | jq -r '.[] | select(.createdAt < "'$threshold'") | .workflowRunUrl' | while read url; do
            echo "Deleting workflow: $url"
            gh run delete --confirm "$url"
          done
