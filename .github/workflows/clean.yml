name: Cleanup Workflows

on:
  schedule:
    - cron: '0 0 * * *'  # 每天0点执行一次清理任务
  workflow_dispatch: # 允许手动触发

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup GitHub CLI
        run: |
          curl -fsSL https://cli.github.com/packages/githubcli-archive.key | sudo tee /etc/apt/trusted.gpg.d/github.asc
          sudo apt-add-repository https://cli.github.com/packages
          sudo apt update
          sudo apt install gh

      - name: Authenticate with GitHub CLI
        run: gh auth login --with-token < ${{ secrets.GIT_TOKEN }}

      - name: Get workflows older than 30 days
        run: |
          # 获取所有工作流
          workflows=$(gh run list --limit 1000 --json createdAt,workflowRunUrl)
          
          # 获取当前日期并设置时间阈值（30天前）
          threshold=$(date -d "30 days ago" +%Y-%m-%dT%H:%M:%S)
          
          # 遍历工作流并删除30天前的工作流
          echo "$workflows" | jq -r '.[] | select(.createdAt < "'$threshold'") | .workflowRunUrl' | while read url; do
            echo "Deleting workflow: $url"
            gh run delete --confirm "$url"
          done

